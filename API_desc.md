# API Documentation - AccuBatt Web

## Изменения в API связанные с новым форматом БД

### Миграция системы заказов

Система заказов была полностью переработана для унификации работы с заказами через постаматы и офисы.

#### Старая структура (deprecated):
- `Orders` - заказы через постаматы
- `OfficeOrders` - офисные заказы

#### Новая структура:
- `UnifiedOrders` - единая таблица для всех заказов
- `OrderTypes` - справочник типов заказов (postamat, office)

---

### Новые модели базы данных

#### OrderTypes (справочник типов заказов)
```json
{
  "type_id": 1,                    // Уникальный идентификатор типа заказа (primary key)
  "type_name": "office",           // Название типа: "postamat" (заказы через постаматы) или "office" (офисные заказы)
  "type_description": "Офисные заказы", // Человекочитаемое описание типа заказа
  "created_at": "2024-01-15 10:30:00"   // Дата и время создания записи в формате YYYY-MM-DD HH:MM:SS
}
```

#### UnifiedOrders (унифицированная таблица заказов)
```json
{
  "order_id": 123,                 // Уникальный идентификатор заказа (primary key, auto increment)
  "product_id": "456",             // Идентификатор товара (может быть строкой или числом в зависимости от legacy данных)
  "client_id": "79123456789",      // Идентификатор клиента (номер телефона или ID пользователя)
  "order_type_id": 1,              // FK на OrderTypes - определяет тип заказа (1=office, 2=postamat)
  
  // Общие поля для всех типов заказов
  "start_time": "2024-01-15 10:30:00",    // Время начала аренды в формате YYYY-MM-DD HH:MM:SS
  "end_time": "2024-01-15 18:30:00",      // Планируемое время окончания аренды в формате YYYY-MM-DD HH:MM:SS
  "rental_time": 480,              // Время аренды в минутах (480 = 8 часов)
  "rental_amount": 240,            // Сумма аренды в рублях (копейки не используются)
  "returned": 0,                   // Статус возврата: 0 = не возвращен (активный), 1 = возвращен
  "renewal_time": null,            // Время продления аренды (nullable, формат YYYY-MM-DD HH:MM:SS)
  
  // Поля для офисных заказов (nullable для заказов через постаматы)
  "ready_for_return": 0,           // Готовность к возврату: 0 = не готов, 1 = готов к возврату в офис
  "issued": 1,                     // Статус выдачи: 0 = не выдан, 1 = выдан клиенту
  "not_issued": 0,                 // Отклонение заказа: 0 = не отклонен, 1 = заказ отклонен/не выдан
  "accepted": 0,                   // Принятие возврата: 0 = не принят, 1 = возврат принят сотрудником
  
  // Поля для заказов через постаматы (nullable для офисных заказов)
  "order_date": null,              // Дата заказа для постамат-заказов (формат YYYY-MM-DD HH:MM:SS)
  "cell_id": null,                 // Номер ячейки в постамате (nullable)
  "postamat_id": null             // Идентификатор постамата (nullable)
}
```

#### WorkerRoles (роли работников)
```json
{
  "role_id": 1,                    // Уникальный идентификатор роли (primary key)
  "role_name": "office_worker",    // Системное имя роли: postamat_worker, office_worker, junior_admin, senior_admin, owner
  "role_description": "Офисный работник" // Человекочитаемое описание роли для интерфейса
}
```

#### Workers (унифицированная таблица работников)
```json
{
  "worker_id": 1,                  // Уникальный идентификатор работника (primary key, auto increment)
  "worker_uid": "office_worker_01", // Логин работника для входа в систему (уникальный)
  "worker_passwd": "hashed_password", // Хешированный пароль работника (не передается в API ответах)
  "role_id": 2,                    // FK на WorkerRoles - определяет права доступа работника
  "created_at": "2024-01-15 09:00:00",   // Дата создания аккаунта работника
  "is_active": 1                   // Статус активности: 0 = деактивирован, 1 = активен
}
```

#### OrderPhotos (фотографии заказов)
```json
{
  "photo_id": 1,                   // Уникальный идентификатор фотографии (primary key, auto increment)
  "order_id": 123,                 // FK на UnifiedOrders - ID заказа, к которому привязана фотография
  "photo_data": "binary_data",     // Бинарные данные фотографии (LargeBinary, до 16MB)
  "photo_type": 0,                 // Тип фотографии: 0 = до аренды/выдачи, 1 = после возврата
  "created_at": "2024-01-15 10:30:00",    // Дата и время создания фотографии
  "file_name": "product_photo.jpg", // Оригинальное имя загруженного файла (nullable)
  "file_size": 1024000,            // Размер файла в байтах (nullable)
  "content_type": "image/jpeg"     // MIME тип файла: image/jpeg, image/png и т.д. (nullable)
}
```

#### Products (товары) - обновлено
```json
{
  "id": 1,                         // Уникальный идентификатор товара (primary key)
  "name": "PowerBank 10000mAh",    // Название товара (max 25 символов)
  "description": "Портативный аккумулятор на 10000mAh", // Описание товара (max 512 символов)
  "price_per_hour": 15.0,          // Цена аренды за час в рублях
  "price_per_day": 200.0,          // Цена аренды за день в рублях
  "price_per_month": 3000.0,       // Цена аренды за месяц в рублях
  "image": "binary_data",          // Изображение товара в бинарном формате (до 16MB)
  "product_uuid": "550e8400-e29b-41d4-a716-446655440000", // UUID товара для QR-кодов
  "size": "medium",                // Размер товара для размещения в ячейках
  "category": "PowerBank",         // Категория товара
  "address_of_postamat": "Ленина 5", // Адрес постамата (если товар в постамате)
  "office_id": 2,                  // FK на Office - ID офиса (если товар в офисе)
  "who_is_reserved": "79123456789", // Номер телефона клиента, зарезервировавшего товар
  "start_of_reservation": "2024-01-15 10:30:00", // Время начала резервирования
  "have_problem": 0                // Статус проблем с товаром: 0 = нет проблем, 1 = есть проблемы
}
```

---

## Обновленные API методы

---

## GET /api/get-active-orders

**Описание:** Получение активных заказов (обновлено для работы с UnifiedOrders)
**Права доступа:** office_worker, junior_admin, senior_admin, owner

**Изменения в новой версии:**
- Использует `UnifiedOrders` вместо `OfficeOrders`
- Автоматически фильтрует по типу заказа "office"
- Улучшенная обработка статусов заказов

**Ответ:**
```json
[
  {
    "order_id": 123,                 // Уникальный идентификатор заказа в системе
    "client_name": "Иван Иванов",    // Полное имя клиента из таблиц пользователей
    "phone_number": "79123456789",   // Номер телефона клиента (используется как идентификатор)
    "product_name": "PowerBank 10000mAh", // Название арендуемого товара
    "address_office": "Ленина 10",   // Адрес офиса, где происходит выдача/возврат товара
    "order_type": "office",          // Тип заказа: "office" или "postamat"
    "start_time": "2024-01-15 10:30:00",    // Время начала аренды
    "end_time": "2024-01-15 18:30:00",      // Планируемое время окончания аренды
    "rental_amount": 240,            // Сумма к оплате за аренду в рублях
    "rental_time": 480,              // Продолжительность аренды в минутах
    "issued": 1,                     // Статус выдачи: 0 = не выдан, 1 = выдан клиенту
    "returned": 0,                   // Статус возврата: 0 = не возвращен, 1 = возвращен
    "ready_for_return": 0,           // Готовность к возврату: 0 = не готов, 1 = готов
    "not_issued": 0,                 // Отклонение: 0 = не отклонен, 1 = заказ отклонен
    "accepted": 0                    // Принятие возврата: 0 = не принят, 1 = принят сотрудником
  }
]
```

---

## GET /api/get-order-details/{order_id}

**Описание:** Получение детальной информации о заказе (обновлено)
**Права доступа:** office_worker, junior_admin, senior_admin, owner

**Изменения:**
- Работает с `UnifiedOrders` и `OrderTypes`
- Возвращает тип заказа и расширенную информацию

**Параметры:**
- `order_id` (URL, required) - Уникальный идентификатор заказа в таблице UnifiedOrders (integer)

**Ответ:**
```json
{
  "order_id": 123,                 // Уникальный идентификатор заказа
  "product_id": "456",             // ID товара (строка или число для совместимости с legacy данными)
  "client_id": "79123456789",      // ID клиента (номер телефона в российском формате)
  "order_type": "office",          // Тип заказа: "office" для офисных заказов, "postamat" для постаматов
  "order_type_id": 1,              // Числовой ID типа заказа из таблицы OrderTypes
  "client_name": "Иван Иванов",    // Полное имя клиента из профиля пользователя
  "product_name": "PowerBank 10000mAh", // Название товара из каталога продуктов
  "start_time": "2024-01-15 10:30:00",    // Фактическое время начала аренды
  "end_time": "2024-01-15 18:30:00",      // Планируемое/фактическое время окончания аренды
  "rental_time": 480,              // Общая продолжительность аренды в минутах
  "rental_amount": 240,            // Итоговая сумма к оплате в рублях (без копеек)
  "address_office": "Ленина 10",   // Полный адрес офиса выдач��/возврата
  "status": {                      // Объект со всеми статусами заказа
    "issued": 1,                   // Выдача товара: 0 = не выдан, 1 = выдан клиенту
    "returned": 0,                 // Возврат товара: 0 = не возвращен, 1 = возвращен
    "ready_for_return": 0,         // Готовность к возврату: 0 = еще используется, 1 = готов к сдаче
    "not_issued": 0,               // Отклонение заказа: 0 = принят, 1 = отклонен сотрудником
    "accepted": 0                  // Принятие возврата: 0 = не принят, 1 = возврат принят и обработан
  },
  "created_at": "2024-01-15 10:30:00",    // Время создания заказа в системе
  "updated_at": "2024-01-15 11:00:00"     // Время последнего обновления заказа
}
```

---

## GET /api/owner/statistics

**Описание:** Статистика владельца (обновлено для работы �� UnifiedOrders)
**Права доступа:** owner

**Изменения:**
- Использует `UnifiedOrders` для получения данных по вс��м типам заказов
- Улучшенная производительность благодаря единой таблице
- Поддержка фильтрации по типам заказов

**Параметры:**
- `period` (query, required) - Период для анализа статистики:
  - `"day"` - статистика за последние 24 часа с разбивкой по часам
  - `"week"` - статистика за последние 7 дней с разбивкой по дням  
  - `"month"` - статистика за последние 30 дней с разбивкой по дням

**Ответ:**
```json
{
  "income": 125000.0,              // Общий доход за выбранный период в рублях
  "orders": 85,                    // Общее количество заказов за период
  "clients": 42,                   // Количество уникальных клиентов за период
  "labels": ["01.01", "02.01", "03.01"],  // Подписи для оси X графика (даты или часы)
  "chart": [15000, 22000, 18000],  // Данные для построения графика доходов по периодам
  "breakdown_by_type": {           // Разбивка статистики по типам заказов (новое поле)
    "office": {                    // Статистика по офисным заказам
      "income": 75000.0,           // Доход от офисных заказов в рублях
      "orders": 45                 // Количество офисных заказов
    },
    "postamat": {                  // Статистика по заказам через постаматы
      "income": 50000.0,           // Доход от постаматов в рублях
      "orders": 40                 // Количество заказов через постаматы
    }
  }
}
```

---

## POST /api/accept-office-return/{return_id}

**Описание:** Принятие возврата товара в офисе (полностью переработано)
**Права доступа:** office_worker, junior_admin, senior_admin, owner

**Изм��нения в новой версии:**
- Работает с `UnifiedOrders` вместо `OfficeOrders`
- Проверяет тип заказа через `OrderTypes`
- **ЗАМЕНЕНО:** `service_required` → `have_problem`
- **УБРАНО:** обработка фотографий (используйте отдельный API для фото)
- **ДОБАВЛЕНО:** сохранение комментария в поле `comment` заказа
- **ДОБАВЛЕНО:** автоматическое обновление статуса товара при наличии проблем

**Параметры:**
- `return_id` (URL, required) - ID заказа для возврата в UnifiedOrders (integer)
- `have_problem` (form, optional) - Есть ли проблемы с товаром (boolean):
  - `true` - товар имеет проблемы, будет помечен как проблемный в таблице products
  - `false` или не указано - товар в порядке
- `comment` (form, optional) - Комментарий сотрудника о состоянии товара (string, max 1000 символов)
  - Сохраняется в поле `comment` таблицы `unified_orders`

**Content-Type:** application/x-www-form-urlencoded

**Ответ:**
```json
{
  "success": true,
  "message": "Return accepted successfully",
  "processed_data": {
    "have_problem": true,                    // Указано ли наличие проблем с товаром
    "product_marked_as_problem": true,       // Был ли товар помечен как проблемный (только если have_problem=true)
    "comment_saved": true                    // Был ли сохранен комментарий
  }
}
```

**Логика обработки:**
1. **Обновление статуса заказа:**
   - `returned = 1` (заказ возвращен)
   - `accepted = 1` (возврат принят)
   - `updated_at` = текущее время

2. **Сохранение комментария:**
   - Если указан параметр `comment`, он сохраняется в поле `comment` заказа

3. **Обработка проблем с товаром:**
   - Если `have_problem = true`, находится товар по `product_id` из заказа
   - У товара устанавливается `have_problem = 1`
   - Товар помечается как требующий внимания/ремонта

---

## 📸 API методы для работы с фотографиями заказов

### POST /api/orders/{order_id}/photos

**Описание:** Загрузка фотографии для заказа
**Права доступа:** office_worker, junior_admin, senior_admin, owner

**Параметры:**
- `order_id` (URL, required) - ID заказа в таблице UnifiedOrders (integer)
- `photo` (file, required) - Файл фотографии для загрузки
  - Поддерживаемые форматы: JPEG, PNG, GIF и другие image/* типы
  - Максимальный размер: 16MB (16777215 байт)
- `photo_type` (form, required) - Тип фотографии (integer):
  - `0` - фото до аренды/выдачи товара (состояние товара при получении)
  - `1` - фото после возврата товара (состояние товара при возврате)

**Content-Type:** multipart/form-data

**Валидация:**
- Проверка существования заказа в базе данных
- Валидация типа файла (только изображения)
- Проверка размера файла (максимум 16MB)
- Валидация photo_type (только 0 или 1)

**Ответ:**
```json
{
  "success": true,
  "photo_id": 15,                          // ID созданной записи фотографии
  "message": "Photo uploaded successfully",
  "photo_info": {
    "file_name": "product_photo.jpg",       // Оригинальное имя загруженного файла
    "file_size": 1024000,                   // Размер файла в байтах
    "content_type": "image/jpeg",           // MIME тип загруженного файла
    "photo_type": 0,                        // Тип фотографии (0 или 1)
    "created_at": "2024-01-15 10:30:00"     // Время загрузки в формате YYYY-MM-DD HH:MM:SS
  }
}
```

**Ошибки:**
- `404` - Заказ не найден
- `400` - Неверный photo_type или слишком большой файл
- `500` - Внутренняя ошибка сервера

---

### GET /api/orders/{order_id}/photos

**Описание:** Получение списка всех фотографий заказа с возможностью фильтрации
**Права доступа:** office_worker, junior_admin, senior_admin, owner

**Параметры:**
- `order_id` (URL, required) - ID заказа в таблице UnifiedOrders (integer)
- `photo_type` (query, optional) - Фильтр по типу фотографии (integer):
  - `0` - показать только фото до аренды
  - `1` - показать только фото после возврата
  - без параметра - показать все фотографии

**Ответ:**
```json
{
  "order_id": 123,                         // ID заказа, для которого запрашивались фото
  "photos": [
    {
      "photo_id": 15,                      // Уникальный ID фотографии
      "photo_type": 0,                     // Тип: 0 = до аренды, 1 = после возврата
      "file_name": "before_rental.jpg",    // Оригинальное имя файла при загрузке
      "file_size": 1024000,                // Размер файла в байтах
      "content_type": "image/jpeg",
      "created_at": "2024-01-15 10:30:00", // Время загрузки фотографии
      "photo_url": "/api/photos/15"        // URL для получения самого изображения
    },
    {
      "photo_id": 16,
      "photo_type": 1,
      "file_name": "after_return.jpg",
      "file_size": 856000,
      "content_type": "image/jpeg",
      "created_at": "2024-01-15 18:45:00",
      "photo_url": "/api/photos/16"
    }
  ],
  "total_photos": 2,                       // Общее количество фотографий для заказа
  "photos_before": 1,                      // Количество фото до аренды (photo_type=0)
  "photos_after": 1                        // Количество фото после возврата (photo_type=1)
}
```

**Сортировка:** Фотографии возвращаются отсортированными по времени создания (новые первыми)

**Ошибки:**
- `404` - Заказ не найден
- `400` - Неверное значение photo_type
- `500` - Внутренняя ошибка сервера

---

### GET /api/photos/{photo_id}

**Описание:** Получение изображения по ID фотографии (возвращает бинарные данные)
**Права доступа:** office_worker, junior_admin, senior_admin, owner

**Параметры:**
- `photo_id` (URL, required) - ID фотографии в таблице OrderPhotos (integer)

**Ответ:**
- **Content-Type:** соответствующий MIME тип (image/jpeg, image/png, и т.д.)
- **Body:** Бинарные данные изображения
- **Headers:**
  - `Content-Disposition: inline; filename="имя_файла.jpg"` - позволяет браузеру отображать изображение

**Пример использования:**
```html
<!-- Прямое отображение изображения в HTML -->
<img src="/api/photos/15" alt="Фото товара до аренды">

<!-- Или ссылка для скачивания -->
<a href="/api/photos/15" download>Скачать фото</a>
```

**Ошибки:**
- `404` - Фотография не найдена
- `500` - Внутренняя ошибка сервера

---

### DELETE /api/photos/{photo_id}

**Описание:** Удаление фотографии по ID (необратимая операция)
**Права доступа:** junior_admin, senior_admin, owner

**Параметры:**
- `photo_id` (URL, required) - ID фотографии для удаления (integer)

**Ответ:**
```json
{
  "success": true,
  "message": "Photo deleted successfully",
  "deleted_photo_id": 15                   // ID удаленной фотографии (для подтверждения)
}
```

**Безопасность:**
- Метод доступен только администраторам и владельцу
- Удаление происходит безвозвратно
- Рекомендуется делать backup перед массовым удалением

**Ошибки:**
- `404` - Фотография не найдена
- `403` - Недостаточно прав доступа
- `500` - Внутренняя ошибка сервера

---

### GET /api/orders/{order_id}/photos/archive

**Описание:** Скачивание ZIP архива всех ф��тографий заказа
**Права доступа:** junior_admin, senior_admin, owner

**Параметры:**
- `order_id` (URL, required) - ID заказа для создания архива (integer)

**Ответ:**
- **Content-Type:** application/zip
- **Body:** ZIP архив с фотографиями заказа
- **Headers:**
  - `Content-Disposition: attachment; filename="order_123_photos.zip"`

**Структура архива:**
```
order_123_photos.zip
├── before_rental_1.jpg          // Фото до аренды (photo_type=0)
├── before_rental_2.jpg          // Если есть несколько фото до аренды
├── after_return_1.jpg           // Фото после возврата (photo_type=1)
└── after_return_2.jpg           // Если есть несколько фото после возврата
```

**Особенности:**
- Файлы в архиве сортируются по времени создания
- Расширение файла определяется по content_type фотографии
- Если у заказа нет фотографий, возвращается ошибка 404

**Ошибки:**
- `404` - Заказ не найден или у него нет фотографий
- `403` - Недостаточно прав доступа
- `500` - Внутренняя ошибка сервера

---

## 📈 API метод для получения полной истории продукта

### GET /api/get-product-history/{product_id}

**Описание:** Мощный endpoint для получения максимальной истории продукта со всей доступной информацией
**Права доступа:** office_worker, junior_admin, senior_admin, owner

**Параметры:**
- `product_id` (URL, required) - ID продукта для получения истории (integer)

**Что включает в себя ответ:**
- Детальная информация о продукте (цены, описание, категория, статус проблем)
- Полная история всех заказов (из unified_orders и legacy таблиц)
- Информация о клиентах для каждого заказа
- Все фотографии для каждого заказа (до аренды и после возврата)
- Детальная статистика использования и доходности
- Информация о проблемах и комментариях сотрудников
- Timeline использования продукта

**Ответ:**
```json
{
  "product_info": {
    "id": 1,
    "name": "PowerBank 10000mAh",
    "description": "Портативный аккумулятор высокой емкости",
    "category": "PowerBank",
    "size": "medium",
    "product_uuid": "550e8400-e29b-41d4-a716-446655440000",
    "pricing": {
      "price_per_hour": 15.0,              // Цена за час аренды
      "price_per_day": 200.0,              // Цена за день аренды
      "price_per_month": 3000.0             // Цена за месяц аренды
    },
    "location": {
      "office_info": {                     // Информация об офисе (если привязан)
        "id": 2,
        "address": "Ленина 10",
        "coordinates": {
          "lat": "55.7558",
          "lng": "37.6176"
        }
      },
      "address_of_postamat": null           // Адрес постамата (если не в офисе)
    },
    "status": {
      "have_problem": false,               // Есть ли проблемы с товаром
      "who_is_reserved": null,             // Кем зарезервирован
      "start_of_reservation": null         // Время резервирования
    },
    "image_url": "/get-product-image/1"    // URL для получения изображения товара
  },
  "orders_history": [                      // Полная история заказов (сортировка по дате, новые первыми)
    {
      "order_id": 123,
      "order_type": "office",              // Тип заказа: office/postamat
      "order_type_text": "Офисный заказ",
      "client_info": {                     // Информация о клиенте
        "id": 456,
        "name": "Иван Петров",
        "phone_number": "79123456789",
        "banned": false                    // Заблокирован ли клиент
      },
      "timeline": {                        // Временная шкала заказа
        "created_at": "2024-01-15 10:30:00",
        "start_time": "2024-01-15 11:00:00",
        "end_time": "2024-01-15 19:00:00",
        "updated_at": "2024-01-15 19:15:00"
      },
      "rental_details": {                  // Детали аренды
        "rental_time_minutes": 480,       // Время аренды в минутах
        "rental_time_hours": 8.0,         // Время аренды в часах
        "rental_amount": 120,             // Сумма к оплате
        "renewal_time": null              // Время продления (если было)
      },
      "status": {                         // Детальный статус заказа
        "code": "returned",               // Код статуса
        "text": "Возвращен",              // Текстовое описание
        "issued": true,                   // Выдан ли товар
        "returned": true,                 // Возврат ли товара
        "ready_for_return": false,        // Готов ли к возврату
        "accepted": true,                 // Принят ли возврат
        "not_issued": false               // Отклонен ли заказ
      },
      "location": {
        "address_office": "Ленина 10"     // Адрес офиса для офисных заказов
      },
      "comments": "Товар в отличном состоянии", // Комментарий сотрудника при возврате
      "has_problems": false,              // Были ли проблемы с товаром
      "photos": [                         // Все фотографии заказа
        {
          "photo_id": 15,
          "photo_type": 0,                // 0 = до аренды, 1 = после возврата
          "photo_type_text": "До аренды",
          "file_name": "before_rental.jpg",
          "file_size": 1024000,
          "content_type": "image/jpeg",
          "created_at": "2024-01-15 11:00:00",
          "photo_url": "/api/photos/15"   // URL для просмотра фото
        },
        {
          "photo_id": 16,
          "photo_type": 1,
          "photo_type_text": "После возврата",
          "file_name": "after_return.jpg",
          "file_size": 856000,
          "content_type": "image/jpeg",
          "created_at": "2024-01-15 19:00:00",
          "photo_url": "/api/photos/16"
        }
      ],
      "photos_count": 2                   // Количество фотографий для заказа
    }
  ],
  "statistics": {                         // Детальная статистика по продукту
    "total_orders": 25,                   // Общее количество заказов
    "active_orders": 2,                   // Активных заказов
    "returned_orders": 22,                // Возвратных заказов
    "rejected_orders": 1,                 // Отклоненных заказов
    "orders_by_type": {                   // Разбивка по типам заказов
      "office_orders": 15,                // Офисных заказов
      "postamat_orders": 10               // Заказов через постаматы
    },
    "financial": {                        // Финансовая статистика
      "total_revenue": 3750.0,            // Общий доход от продукта
      "average_order_value": 150.0,       // Средняя стоимость заказа
      "revenue_per_hour": 18.75           // Доход за час использования
    },
    "usage": {                           // Статистика использования
      "total_rental_hours": 200.0,       // Общее время аренды в часах
      "average_rental_time": 8.0,        // Среднее время аренды за заказ
      "unique_clients": 18                // Количество уникальных клиентов
    },
    "photos": {                          // Статистика по фотографиям
      "total_photos": 45,                 // Общее количество фотографий
      "orders_with_photos": 20,           // Заказов с фотографиями
      "photo_coverage": 80.0              // Процент заказов с фотографиями
    },
    "problems": {                        // Статистика проблем
      "problems_count": 2,                // Количество заказов с проблемами
      "product_has_problems": false,      // Помечен ли продукт как проблемный
      "problem_rate": 8.0                 // Процент заказов с проблемами
    }
  },
  "timeline": {                          // Временная шкала исполь��ования
    "first_order": {                     // Первый заказ продукта
      "created_at": "2023-06-15 14:30:00",
      "start_time": "2023-06-15 15:00:00",
      "end_time": "2023-06-15 23:00:00",
      "updated_at": "2023-06-15 23:30:00"
    },
    "last_order": {                      // Последний заказ продукта
      "created_at": "2024-01-15 10:30:00",
      "start_time": "2024-01-15 11:00:00",
      "end_time": "2024-01-15 19:00:00",
      "updated_at": "2024-01-15 19:15:00"
    },
    "total_usage_days": null             // Общий период использования (будет добавлено)
  },
  "meta": {                              // Метаинформация о запросе
    "generated_at": "2024-01-20 14:35:22", // Время генерации отчета
    "total_records": 25,                 // Общее количество записей
    "data_sources": [                    // Источники данных
      "unified_orders",
      "legacy_orders", 
      "order_photos",
      "users"
    ]
  }
}
```

**Особенности endpoint:**

1. **Полнота данных:**
   - Собирает данные из новой таблицы `unified_orders`
   - Включает legacy данные из старых таблиц `orders` и `office_orders`
   - Избегает дублирования записей при объединении данных
   - Автоматически помечает legacy заказы для идентификации

2. **Детализация клиентов:**
   - Поиск клиентов по ID и номеру телефона для совместимости
   - Информация о статусе блокировки клиентов
   - Подсчет уникальных клиентов для статистики
   - Обработка случаев отсутствия данных о клиентах

3. **Система фотографий:**
   - Все фотографии для каждого заказа с полными метаданным
   - Четкое разделение на "до аренды" (photo_type=0) и "после возврата" (photo_type=1)
   - Готовые URL для прямого просмотра изображений
   - Статистика покрытия заказов фотографиями

4. **Комплексная статистика:**
   - **Финансовые показатели:** общий доход, средний чек, доход за час использования
   - **Показатели использования:** общее время аренды, среднее время за заказ
   - **Качественные метрики:** процент заказов с проблемами, покрытие фотографиями
   - **Операционная статистика:** разбивка по типам заказов, количество уникальных клиентов

5. **Умная обработка статусов:**
   - Автоматическое определение статуса заказа на основе флагов
   - Человекочитаемые описания статусов на русском языке
   - Проверка наличия проблем через анализ комментариев сотрудников
   - Поддержка всех возможных состояний заказа

6. **Временная шкала (Timeline):**
   - Информация о первом и последнем заказе товара
   - Полная хронология для анализа жизненного цикла продукта
   - Возможность расширения для расчета общего периода использования

**Практическое применение:**
- **Аналитика эффективности:** детальный анализ доходности конкретного товара
- **Мониторинг качества:** отслеживание проблем и состояния товара через фотографии
- **Клиентская аналитика:** анализ поведения и предпочтений клиентов
- **Планирование обслуживания:** прогнозирование необходимости ремонта или замены
- **Отчетность для владельцев:** comprehensive отчеты для принятия бизнес-решений
- **Операционное управление:** оптимизация процессов выдачи и возврата

**Безопасность и производительность:**
- Оптимизированные запросы к базе данных с минимальным количеством JOIN
- Обработка больших объемов данных с сортировкой на уровне приложения
- Защита от SQL-инъекций через параметризованные запросы
- Ограничение доступа только для авторизованных сотрудников

**Обработка ошибок:**
- `404` - Продукт с указанным ID не найден в системе
- `403` - Недостаточно прав доступа (требуется роль office_worker или выше)
- `500` - Внутренняя ошибка сервера при обработке данных

**Совместимость:**
- Полная поддержка legacy данных из старых таблиц
- Плавная миграция между старой и новой системой заказов
- Автоматическая пометка источника данных для каждого заказа

---

## Troubleshoot API - Управление проблемными товарами

Группа API эндпоинтов для работы с товарами, имеющими проблемы. Включает функции диагностики, решения проблем, выставления штрафов и статистики.

### Базовый URL
Все эндпоинты доступны по адресу: `http://your-domain/api/`

### Авторизация
Все эндпоинты требуют авторизации через cookies. Уровни доступа:
- `office_worker` - сотрудник офиса
- `junior_admin` - младший администратор  
- `senior_admin` - старший администратор
- `owner` - владелец

---

## 1. GET /api/get-problem-products

**Описание:** Получение списка всех товаров с проблемами

**Доступ:** `office_worker`, `junior_admin`, `senior_admin`, `owner`

**Параметры:** Отсутствуют

**Ответ:**
```json
{
  "success": true,
  "problem_products": [
    {
      "id": 123,
      "name": "Аккумулятор Samsung",
      "description": "Портативный аккумулятор 10000mAh",
      "category": "Аккумуляторы",
      "size": "средний",
      "location": {
        "type": "office",
        "id": 1,
        "address": "ул. Ленина, 10"
      },
      "last_order": {
        "order_id": 456,
        "client_name": "Иван Иванов",
        "client_phone": "89001234567",
        "end_time": "2024-08-20 15:30:00",
        "returned": true,
        "comment": "Товар поврежден при возврате"
      },
      "reservation_status": {
        "is_reserved": false,
        "reserved_by": null,
        "reservation_start": null
      }
    }
  ],
  "total_count": 5
}
```

---

## 2. POST /api/solve-problem/{product_id}

**Описание:** Решение проблемы с товаром

**Доступ:** `office_worker`, `junior_admin`, `senior_admin`, `owner`

**Параметры URL:**
- `product_id` (int) - ID товара

**Параметры тела (Form):**
- `solution_comment` (string, обязательный) - Комментарий о решении проблемы
- `mark_as_solved` (boolean, по умолчанию true) - Отметить как решенную

**Пример запроса:**
```
POST /api/solve-problem/123
Content-Type: application/x-www-form-urlencoded

solution_comment=Заменен поврежденный корпус&mark_as_solved=true
```

**Ответ:**
```json
{
  "success": true,
  "message": "Проблема успешно решена",
  "product_id": 123,
  "solved": true
}
```

---

## 3. POST /api/create-fine/{product_id}

**Описание:** Создание штрафа за повреждение/потерю товара

**Доступ:** `junior_admin`, `senior_admin`, `owner`

**Параметры URL:**
- `product_id` (int) - ID товара

**Параметры тела (Form):**
- `fine_amount` (float, обязательный) - Сумма штрафа в рублях
- `fine_reason` (string, обязательный) - Причина штрафа
- `client_id` (string, опциональный) - ID клиента (если не указан, берется из последнего заказа)

**Ответ:**
```json
{
  "success": true,
  "message": "Штраф успешно создан",
  "fine_details": {
    "product_id": 123,
    "client_id": "89001234567",
    "client_name": "Иван Иванов",
    "client_phone": "89001234567",
    "amount": 1500.00,
    "reason": "Повреждение корпуса",
    "created_by": "junior_admin ID:5",
    "created_at": "2024-08-21 14:30:00"
  }
}
```

---

## 💳 API платежной системы CloudPayments

### Привязка банковских карт

#### GET `/api/payments/card-binding-form`
Форма для привязки банковской карты пользователя.

**Требования:**
- API ключ в заголовке `X-API-Key`

**Параметры запроса:**
- `user_id` (обязательный) - ID пользователя

**Ответ:**
HTML форма для ввода данных карты и привязки через CloudPayments.

---

#### POST `/api/payments/cloudpayments-webhook`
Webhook для обработки уведомлений от CloudPayments о статусе платежей.

**Описание:**
Обрабатывает уведомления от CloudPayments в формате `application/x-www-form-urlencoded`.

**Логика обработки:**
- Платежи на сумму 11 рублей обрабатываются как привязка карты
- При успешной оплате карта сохраняется с токеном для будущих списаний
- Все транзакции сохраняются в таблицу `payment_transactions`

**Ответ:**
```json
{
  "code": 0  // 0 = успех, другие коды = ошибка
}
```

---

### Управление картами пользователя

#### GET `/api/payments/cards/{user_id}`
Получить все привязанные карты пользователя.

**Требования:**
- API ключ в заголовке `X-API-Key`

**Ответ:**
```json
{
  "success": true,
  "cards": [
    {
      "id": 1,
      "last4_digits": "1234",
      "card_type": "Visa",
      "created_at": "2024-01-15T10:30:00"
    }
  ]
}
```

---

### Платежные операции

#### POST `/api/payments/charge`
Списание средств с привязанной карты.

**Требования:**
- API ключ в заголовке `X-API-Key`

**Тело запроса:**
```json
{
  "user_id": "123",
  "card_id": 1,
  "amount": 100.50,
  "order_id": "order_456"
}
```

**Ответ:**
```json
{
  "success": true,
  "transaction_id": "12345678",
  "message": "Платеж успешно проведен"
}
```

---

## 📱 API аутентификации через Telegram

### Виджет входа через Telegram

#### GET `/api/telegram/login-widget`
Страница с Telegram Login Widget для аутентификации.

**Ответ:**
HTML страница с виджетом входа через Telegram.

---

### Управление Telegram аккаунтами

#### POST `/api/telegram/verify-auth`
Проверка и сохранение данных Telegram аутентификации.

**Требования:**
- API ключ в заголовке `X-API-Key`

**Тело запроса:**
```json
{
  "user_id": "123",
  "telegram_data": {
    "id": "987654321",
    "first_name": "Иван",
    "last_name": "Иванов",
    "username": "ivanov_ivan",
    "auth_date": "1642234567",
    "hash": "abc123def456"
  }
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Telegram успешно привязан к аккаунту",
  "telegram_id": "987654321",
  "username": "ivanov_ivan",
  "first_name": "Иван"
}
```

---

## 💰 API системы штрафов

### Управление штрафами

#### POST `/api/create-fine`
Создание нового штрафа.

**Требования:**
- Роль: `junior_admin`, `senior_admin`, `owner`

**Тело запроса (form-data):**
- `user_id` (int) - ID пользователя
- `product_id` (int) - ID товара
- `fine_amount` (float) - Сумма штрафа
- `fine_reason` (string) - Причина штрафа
- `fine_description` (string, опционально) - Дополнительное описание
- `order_id` (int, опционально) - ID связанного заказа
- `due_days` (int, по умолчанию 14) - Срок оплаты в днях

**Ответ:**
```json
{
  "success": true,
  "fine_id": 123,
  "message": "Штраф успешно создан"
}
```

---

#### GET `/api/fines`
Получение списка всех штрафов.

**Требования:**
- Роль: `junior_admin`, `senior_admin`, `owner`

**Ответ:**
```json
{
  "success": true,
  "fines": [
    {
      "fine_id": 123,
      "user_phone": "+79123456789",
      "user_name": "Иван Иванов",
      "amount": 500.00,
      "reason": "Повреждение оборудования",
      "status": "unpaid",
      "created_at": "2024-01-15T10:30:00",
      "paid_at": null,
      "notes": "Дополнительные замечания"
    }
  ]
}
```

---

### Панель владельца

#### GET `/owner/fines`
Страница управления штрафами для владельца.

**Требования:**
- Роль: `owner`

**Функциональность:**
- Просмотр всех штрафов в системе
- Создание новых штрафов
- Изменение статуса оплаты
- Удаление штрафов

---

### Панель старшего администратора

#### GET `/admin-senior/fines`
Страница управления штрафами для старшего администратора.

**Требования:**
- Роль: `senior_admin`

**Функциональность:**
- Просмотр всех штрафов в системе
- Создание новых штрафов
- Изменение статуса оплаты
- Удаление штрафов

---

## 📋 Новые модели базы данных

### UserCard (привязанные карты пользователей)
```json
{
  "id": 1,
  "user_id": "123",
  "card_token": "tk_abc123def456",
  "last4_digits": "1234",
  "card_type": "Visa",
  "created_at": "2024-01-15T10:30:00",
  "is_active": true
}
```

### TelegramUser (данные Telegram пользователей)
```json
{
  "id": 1,
  "user_id": "123",
  "telegram_id": 987654321,
  "telegram_username": "ivanov_ivan",
  "first_name": "Иван",
  "last_name": "Иванов",
  "phone_number": "+79123456789",
  "verified_at": "2024-01-15T10:30:00",
  "is_verified": true
}
```

### PaymentTransaction (история транзакций)
```json
{
  "id": 1,
  "transaction_id": "12345678",
  "user_id": "123",
  "order_id": "order_456",
  "amount": "100.50",
  "currency": "RUB",
  "status": "Completed",
  "operation_type": "Payment",
  "card_first_six": "123456",
  "card_last_four": "1234",
  "card_type": "Visa",
  "gateway_name": "CloudPayments",
  "test_mode": false,
  "created_at": "2024-01-15T10:30:00",
  "updated_at": "2024-01-15T10:30:00",
  "raw_data": "{\"full_json_from_cloudpayments\": \"...\"}"
}
```

### Fines (система штрафов)
```json
{
  "fine_id": 123,
  "user_phone": "+79123456789",
  "user_name": "Иван Иванов",
  "amount": 500.00,
  "reason": "Повреждение оборудования",
  "status": "unpaid",  // unpaid, paid, pending, cancelled
  "created_at": "2024-01-15T10:30:00",
  "paid_at": null,
  "payment_transaction_id": "12345678",
  "created_by_worker_id": 5,
  "notes": "Дополнительные замечания"
}
```

---

## 🔐 Аутентификация и безопасность

### API ключи
Для доступа к защищенным эндпоинтам требуется передача API ключа в заголовке:
```
X-API-Key: your_api_key_here
```

### Переменные окружения
Для работы новой функциональности требуются следующие переменные:

```env
# CloudPayments
CLOUDPAYMENTS_PUBLIC_ID=pk_your_public_id
CLOUDPAYMENTS_API_SECRET=your_api_secret

# Telegram Bot
BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
BOT_USERNAME=your_bot_username

# API безопасность
API_KEY=your_secure_api_key
```

---

## 🚀 Развертывание

### Создание новых таблиц
Для добавления новых таблиц в существующую базу данных выполните:

```bash
python create_payment_tables.py
```

Скрипт создаст следующие таблицы:
- `user_cards` - привязанные карты пользователей
- `telegram_users` - данные Telegram пользователей
- `payment_transactions` - история платежных транзакций
- `fines` - система штрафов

### Настройка CloudPayments
1. Зарегистрируйтесь в CloudPayments
2. Получите Public ID и API Secret
3. Настройте webhook URL: `https://your-domain.com/api/payments/cloudpayments-webhook`
4. Добавьте переменные окружения

### Настройка Telegram Bot
1. Создайте бота через @BotFather
2. Получите токен бота
3. Настройте домен для Login Widget
4. Добавьте переменные окружения
