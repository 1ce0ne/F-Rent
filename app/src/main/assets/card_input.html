<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            height: 100%;
        }
        .card-form {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 25px;
            max-width: 100%;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .expiry-cvv {
            display: flex;
            gap: 15px;
        }
        .expiry, .cvv {
            flex: 1;
        }
        .add-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .error-message {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>

<!-- üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø CLOUDPAYMENTS -->
<div id="cloudpayments-container" style="display: none;"></div>

<div class="card-form">
    <div style="font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px;">
        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
    </div>
    <div class="form-group">
        <label for="card-number">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
        <input type="text" id="card-number" placeholder="1234 5678 9012 3456" inputmode="numeric" maxlength="19">
        <div id="cardError" class="error-message"></div>
    </div>
    <div class="form-group expiry-cvv">
        <div class="expiry">
            <label for="expiry">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (MM/YY)</label>
            <input type="text" id="expiry" placeholder="MM/YY" inputmode="numeric" maxlength="5">
            <div id="expiryError" class="error-message"></div>
        </div>
        <div class="cvv">
            <label for="cvv">CVV/CVC</label>
            <input type="text" id="cvv" placeholder="123" inputmode="numeric" maxlength="3">
            <div id="cvvError" class="error-message"></div>
        </div>
    </div>
    <div class="form-group">
        <label for="cardholder">–ò–º—è –¥–µ—Ä–∂–∞—Ç–µ–ª—è (–∫–∞–∫ –Ω–∞ –∫–∞—Ä—Ç–µ)</label>
        <input type="text" id="cardholder" placeholder="IVAN IVANOV">
        <div id="cardholderError" class="error-message"></div>
    </div>
    <button type="button" id="addCardButton" class="add-button">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É</button>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ CloudPayments —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    function loadCloudPayments() {
        return new Promise((resolve, reject) => {
            // –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
            if (window.cp && window.cp.Checkout) {
                console.log("CloudPayments —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
                return resolve();
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —Å–∫—Ä–∏–ø—Ç
            if (document.querySelector('script[src="https://checkout.cloudpayments.ru/checkout.js"]')) {
                console.log("–°–∫—Ä–∏–ø—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω, –æ–∂–∏–¥–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏");
                const interval = setInterval(() => {
                    if (window.cp && window.cp.Checkout) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 50);
                setTimeout(() => {
                    clearInterval(interval);
                    reject(new Error("CloudPayments –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è"));
                }, 5000);
                return;
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
            const script = document.createElement('script');
            script.src = 'https://checkout.cloudpayments.ru/checkout.js';
            script.async = true;

            script.onload = () => {
                console.log("–°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–µ–º cp.Checkout...");
                const interval = setInterval(() => {
                    if (window.cp && window.cp.Checkout) {
                        clearInterval(interval);
                        console.log("CloudPayments –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
                        resolve();
                    }
                }, 50);
                setTimeout(() => {
                    clearInterval(interval);
                    reject(new Error("CloudPayments –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ Checkout –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"));
                }, 5000);
            };

            script.onerror = () => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CloudPayments");
                reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å CloudPayments (–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)"));
            };

            document.head.appendChild(script);
        });
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
    function formatCardNumber(value) {
        return value.replace(/\s+/g, '').replace(/(\d{4})/g, '$1 ').trim();
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
    function formatExpiry(value) {
        return value.replace(/\D/g, '').replace(/(\d{2})(\d{0,2})/, '$1/$2');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–æ—Å—Å–∏–π—Å–∫–∞—è –ª–∏ –∫–∞—Ä—Ç–∞
    function isRussianCard(cardNumber) {
        return /^[245]/.test(cardNumber.replace(/\s/g, ''));
    }

    // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏ –ø–æ–¥ –ø–æ–ª–µ–º
    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = 'block';
        const inputId = elementId.replace('Error', '');
        const input = document.getElementById(inputId);
        if (input) input.style.borderColor = '#f44336';
    }

    // –°–∫—Ä—ã—Ç–∏–µ –æ—à–∏–±–∫–∏
    function hideError(elementId) {
        const element = document.getElementById(elementId);
        element.style.display = 'none';
        const inputId = elementId.replace('Error', '');
        const input = document.getElementById(inputId);
        if (input) input.style.borderColor = '#ddd';
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
    document.addEventListener('DOMContentLoaded', function() {
        const cardNumber = document.getElementById('card-number');
        const expiry = document.getElementById('expiry');
        const cvv = document.getElementById('cvv');
        const cardholder = document.getElementById('cardholder');
        const addButton = document.getElementById('addCardButton');

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞
        cardNumber.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '');
            if (value.length > 16) value = value.substring(0, 16);
            e.target.value = formatCardNumber(value);
            hideError('cardError');
        });

        expiry.addEventListener('input', function(e) {
            e.target.value = formatExpiry(e.target.value);
            hideError('expiryError');
        });

        cvv.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
            hideError('cvvError');
        });

        cardholder.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
            hideError('cardholderError');
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
        addButton.addEventListener('click', async function() {
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏
            addButton.disabled = true;
            addButton.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            addButton.style.opacity = '0.7';

            const cardNum = cardNumber.value.replace(/\s+/g, '');
            const exp = expiry.value;
            const cvvVal = cvv.value;
            const name = cardholder.value.trim();

            // –°–±—Ä–æ—Å –æ—à–∏–±–æ–∫
            ['cardError', 'expiryError', 'cvvError', 'cardholderError'].forEach(hideError);

            let isValid = true;

            if (!/^\d{16}$/.test(cardNum)) {
                showError('cardError', '–í–≤–µ–¥–∏—Ç–µ 16 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã');
                isValid = false;
            } else if (!isRussianCard(cardNum)) {
                showError('cardError', '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∫–∞—Ä—Ç—ã');
                isValid = false;
            }

            if (!/^\d{2}\/\d{2}$/.test(exp)) {
                showError('expiryError', '–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YY');
                isValid = false;
            }

            if (!/^\d{3}$/.test(cvvVal)) {
                showError('cvvError', '–í–≤–µ–¥–∏—Ç–µ 3 —Ü–∏—Ñ—Ä—ã CVV');
                isValid = false;
            }

            if (name.length < 2) {
                showError('cardholderError', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–µ—Ä–∂–∞—Ç–µ–ª—è');
                isValid = false;
            }

            if (!isValid) {
                Android.showError("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö");
                addButton.disabled = false;
                addButton.textContent = '–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É';
                addButton.style.opacity = '1';
                return;
            }

            try {
                await loadCloudPayments();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ cp –∏ cp.Checkout –¥–æ—Å—Ç—É–ø–Ω—ã
                if (!window.cp || !window.cp.Checkout) {
                    throw new Error("CloudPayments –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω: cp –∏–ª–∏ cp.Checkout –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
                }

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                const container = document.getElementById('cloudpayments-container');
                if (!container) {
                    throw new Error("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 'cloudpayments-container' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM");
                }

                // –°–æ–∑–¥–∞—ë–º checkout (–∏—Å–ø–æ–ª—å–∑—É–µ–º let, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å redeclaration)
                let checkout = new cp.Checkout(
                    "pk_226ebc1a830dc5b4da1b575931642",
                    {
                        language: "ru",
                        container: container  // ‚¨ÖÔ∏è –Ø–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    }
                );

                // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞–º–º—ã
                const cryptogram = checkout.createPaymentCryptogram({
                    cardNumber: cardNum,
                    expDate: exp,
                    cvv: cvvVal,
                    cardHolder: name
                });

                if (!cryptogram) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞–º–º—É");
                }

                console.log("–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞–º–º–∞ —Å–æ–∑–¥–∞–Ω–∞:", cryptogram.substring(0, 20) + "...");
                Android.receiveCryptogram(cryptogram);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞—Ä—Ç—ã:', error);
                Android.showError("–û—à–∏–±–∫–∞: " + error.message);
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏
                addButton.disabled = false;
                addButton.textContent = '–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É';
                addButton.style.opacity = '1';
            }
        });
    });
</script>
</body>
</html>