<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход через Telegram</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: #0088cc;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        h1 {
            margin: 0 0 10px;
            color: #333;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .telegram-widget {
            margin: 30px 0;
            display: flex;
            justify-content: center;
        }

        .note {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">T</div>
        <h1>Вход в AccuBatt</h1>
        <p class="subtitle">Войдите через Telegram для продолжения</p>

        <div class="telegram-widget">
            <script async src="https://telegram.org/js/telegram-widget.js?22"
                    data-telegram-login="{{ bot_username }}"
                    data-size="large"
                    data-onauth="onTelegramAuth(user)"
                    data-request-access="write">
            </script>
        </div>

        <p class="note">
            Используется стандартная авторизация Telegram с подтверждением через код в приложении
        </p>
    </div>

    <script>
        function onTelegramAuth(user) {
            console.log('Telegram auth success:', user);

            // Отправляем данные на сервер
            fetch('/mobile/auth/telegram-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': '{{ api_key }}'
                },
                body: JSON.stringify(user)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Передаем данные в приложение
                    const authData = {
                        success: true,
                        token: result.token,
                        user_id: result.user_id,
                        session_id: result.session_id,
                        telegram_id: user.id,
                        username: user.username || '',
                        first_name: user.first_name || '',
                        last_name: user.last_name || '',
                        phone: user.phone_number || '',
                        banned: result.banned || false,
                        ban_reason: result.ban_reason || null
                    };

                    // Отправляем в мобильное приложение
                    sendToApp(authData);
                } else {
                    alert('Ошибка авторизации: ' + (result.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при авторизации');
            });
        }

        function sendToApp(authData) {
            try {
                // React Native WebView
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'telegram_auth_complete',
                        data: authData
                    }));
                    return;
                }

                // iOS WKWebView
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.telegramAuth) {
                    window.webkit.messageHandlers.telegramAuth.postMessage(authData);
                    return;
                }

                // Android WebView
                if (window.AndroidInterface && window.AndroidInterface.onTelegramAuth) {
                    window.AndroidInterface.onTelegramAuth(JSON.stringify(authData));
                    return;
                }

                // Custom URL Scheme
                window.location.href = `akkubatt://auth-complete?data=${encodeURIComponent(JSON.stringify(authData))}`;

            } catch (error) {
                console.error('Error sending data to app:', error);
                // Сохраняем в localStorage как резерв
                localStorage.setItem('telegram_auth_data', JSON.stringify(authData));
                alert('Авторизация успешна! Вернитесь в приложение.');
            }
        }
    </script>
</body>
</html>

